{% extends "plantilla.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block css %}
<link rel="stylesheet" href="{% static 'assets/calendario/css/bootstrap-datepicker.standalone.css' %}">
<link rel="stylesheet" href="{% static 'assets/select2/css/bootstrap-select.min.css' %}">
{% endblock %}

{% block contenido %}
<div class="container mt-4">
    <h1>Registrar Venta</h1>
    <form method="post">
        {% csrf_token %}
        <div class="row mb-3">
            <div class="col-md-1">
                <label for="fecha_venta">Fecha</label>
            </div>
            <div class="col-md-2">
                <div class="input-group date">
                    <input type="text" class="form-control datepicker" name="fecha_venta" id="fecha_venta"
                        value="{{ fecha_hoy|default:'' }}" style="text-align:center;" required>
                    <div class="input-group-append">
                        <button class="btn btn-primary date-set" type="button">
                            <i class="fa fa-calendar"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-1"></div>
            <div class="col-md-1">
                <label for="idtipo">Tipo</label>
            </div>
            <div class="col-md-2">
                <select class="form-control" id="idtipo" name="idtipo" required>
                    <option value="">Seleccione tipo</option>
                    {% for tipo in tipos %}
                        <option value="{{ tipo.idtipo }}">{{ tipo.descripcion }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-1"></div>
            <div class="col-md-1">
                <label for="nrodoc">No Doc.</label>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" name="nrodoc" id="nrodoc" readonly>
                <input type="hidden" name="numeracion" id="numeracion">
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-1">
                <label for="idcliente">Cliente</label>
            </div>
            <div class="col-md-7">
                <select class="form-control selectpicker" data-live-search="true" id="idcliente" name="idcliente" required>
                    <option value="">- Seleccione Cliente -</option>
                    {% for cliente in clientes %}
                        <option value="{{ cliente.idcliente }}_{{ cliente.ruc_dni }}_{{ cliente.direccion }}">
                            {{ cliente.nombres }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-1"></div>
            <div class="col-md-1">
                <label for="ruc">RUC/DNI</label>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" name="ruc" id="ruc" readonly>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-1">
                <label for="direccion">Dirección</label>
            </div>
            <div class="col-md-11">
                <input type="text" class="form-control" name="direccion" id="direccion" readonly>
            </div>
        </div>

        <div class="row mb-3 align-items-end">
            <div class="col-md-1">
                <label for="idproducto">Producto</label>
            </div>
            <div class="col-md-6">
                <select class="form-control selectpicker" data-live-search="true" id="idproducto" name="idproducto">
                    <option value="">- Seleccione Producto -</option>
                    {% for producto in productos %}
                        <option value="{{ producto.idproducto }}">{{ producto.descripcion }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-1 text-right">
                <label for="unidad">Unidad</label>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" name="unidad" id="unidad" readonly>
            </div>
        </div>

        <div class="row mb-3 align-items-end">
            <div class="col-md-2"></div>
            <div class="col-md-1">
                <label for="precio">Precio</label>
            </div>
            <div class="col-md-2">
                <input type="number" step="0.01" class="form-control" name="precio" id="precio" readonly>
            </div>
            <div class="col-md-1">
                <label for="cantidad">Cantidad</label>
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control" name="cantidad" id="cantidad">
            </div>
            <div class="col-md-3">
                <button type="button" id="btnadddet" class="btn btn-success">
                    <i class="fas fa-shopping-cart"></i> Agregar al carrito
                </button>
            </div>
            <div class="col-md-1">
                <input type="number" class="form-control" name="stock" id="stock" hidden>
            </div>
        </div>

        <div class="col-md-12 pt-3">
            <div class="table-responsive">
                <table id="detalles" class="table table-striped table-bordered table-condensed table-hover" style='background-color:#FFFFFF;'>
                    <thead class="thead-default" style="background-color:#3c8dbc; color: #fff;">
                        <tr class="text-center">
                            <th width="10">OPCIONES</th>
                            <th>CODIGO</th>
                            <th>DESCRIPCIÓN</th>
                            <th>UNIDAD</th>
                            <th>CANTIDAD</th>
                            <th>P.VENTA</th>
                            <th>IMPORTE</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot></tfoot>
                </table>
            </div>
            
            <div class="row" id="fila_igv" style="display: none;">
                <div class="col-md-8"></div>
                <div class="col-md-2">
                    <label for="igv">IGV (18%):</label>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control text-right" name="igv" id="igv" readonly>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8"></div>
                <div class="col-md-2">
                    <label for="total">Total:</label>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control text-right" name="total" id="total" readonly>
                </div>
            </div>
            
        </div>

        <div class="col-md-12 text-center mt-4">
            <div class="form-group">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Registrar</button>
                <a href="{% url 'listar_venta' %}" class="btn btn-danger">
                    <i class="fas fa-ban"></i> Cancelar
                </a>
            </div>
        </div>
        <input type="hidden" name="detalles" id="detalles_json">
    </form>
</div>
{% endblock %}

{% block js %}
<script src="{% static 'assets/select2/js/bootstrap-select.min.js' %}"></script>
<script src="{% static 'assets/calendario/js/bootstrap-datepicker.min.js' %}"></script>
<script src="{% static 'assets/calendario/locales/bootstrap-datepicker.es.min.js' %}"></script>
<script>
    $(document).ready(function () {
        // Inicializar componentes
        $('.datepicker').datepicker({
            format: 'yyyy-mm-dd',
            language: 'es',
            autoclose: true
        });
        $('.selectpicker').selectpicker();

        // Array para almacenar los detalles de la venta
        var detalles = [];
        var cont = 0;

        // Cliente: autocompletar RUC y dirección
        $('#idcliente').on('change', function() {
            var datos = $(this).val().split('_');
            if (datos.length >= 3) {
                $('#ruc').val(datos[1] || '');
                $('#direccion').val(datos[2] || '');
            } else {
                $('#ruc').val('');
                $('#direccion').val('');
            }
        });

        // Tipo: autocompletar número de documento
        $('#idtipo').on('change', function() {
            var tipoId = $(this).val();
            if (tipoId) {
                $.ajax({
                    url: '/encontrar_tipo/' + tipoId + '/',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        if (data.length > 0) {
                            var parametro = data[0];
                            var siguienteNum = parseInt(parametro.numeracion) + 1;
                            var nroDoc = parametro.serie + '-' + siguienteNum.toString().padStart(6, '0');
                            $('#nrodoc').val(nroDoc);
                            $('#numeracion').val(siguienteNum);
                        }
                    },
                    error: function() {
                        $('#nrodoc').val('');
                        $('#numeracion').val('');
                    }
                });
            } else {
                $('#nrodoc').val('');
                $('#numeracion').val('');
                calcularTotales();
            }
        });

        // Producto: autocompletar unidad, precio y stock
        $('#idproducto').on('change', function() {
            var productoId = $(this).val();
            if (productoId) {
                $.ajax({
                    url: '/encontrar_producto/' + productoId + '/',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        if (data.length > 0) {
                            var producto = data[0];
                            $('#unidad').val(producto.unidad);
                            $('#precio').val(producto.precio);
                            $('#stock').val(producto.stock);
                        }
                    },
                    error: function() {
                        $('#unidad').val('');
                        $('#precio').val('');
                        $('#stock').val('');
                    }
                });
            } else {
                $('#unidad').val('');
                $('#precio').val('');
                $('#stock').val('');
            }
        });

        // Agregar producto al carrito
        $('#btnadddet').click(function() {
            agregar();
        });

        function agregar() {
            var idproducto = $('#idproducto').val();
            var producto = $('#idproducto option:selected').text();
            var unidad = $('#unidad').val();
            var precio = parseFloat($('#precio').val());
            var cantidad = parseFloat($('#cantidad').val());
            var stock = parseInt($('#stock').val());

            // Validaciones
            if (!idproducto) {
                alert('Debe seleccionar un producto');
                return;
            }
            if (!cantidad || cantidad <= 0) {
                alert('Debe ingresar una cantidad válida');
                return;
            }
            if (cantidad > stock) {
                alert('No hay suficiente stock. Stock disponible: ' + stock);
                return;
            }

            // Verificar si el producto ya está en el carrito
            var existe = false;
            for (var i = 0; i < detalles.length; i++) {
                if (detalles[i].codigo == idproducto) {
                    existe = true;
                    break;
                }
            }

            if (existe) {
                alert('El producto ya está agregado al carrito');
                return;
            }

            var importe = cantidad * precio;

            // Agregar al array de detalles
            var detalle = {
                codigo: idproducto,
                descripcion: producto,
                unidad: unidad,
                cantidad: cantidad,
                precio: precio,
                importe: importe
            };
            detalles.push(detalle);

            // Agregar fila a la tabla
            var fila = '<tr class="selected" id="fila' + cont + '">' +
                '<td><button type="button" class="btn btn-danger btn-sm" onclick="eliminar(' + cont + ');">X</button></td>' +
                '<td>' + idproducto + '</td>' +
                '<td>' + producto + '</td>' +
                '<td>' + unidad + '</td>' +
                '<td>' + cantidad + '</td>' +
                '<td>' + precio.toFixed(2) + '</td>' +
                '<td>' + importe.toFixed(2) + '</td>' +
                '</tr>';

            cont++;
            $('#detalles tbody').append(fila);
            
            // Limpiar campos
            limpiarCampos();
            
            // Calcular total
            calcularTotales();
        }

        // Función para eliminar producto del carrito
        window.eliminar = function(index) {
            $('#fila' + index).remove();
            // Remover del array (buscar por el índice visual)
            var tabla = $('#detalles tbody tr');
            detalles = [];
            tabla.each(function() {
                var codigo = $(this).find('td:eq(1)').text();
                var descripcion = $(this).find('td:eq(2)').text();
                var unidad = $(this).find('td:eq(3)').text();
                var cantidad = parseFloat($(this).find('td:eq(4)').text());
                var precio = parseFloat($(this).find('td:eq(5)').text());
                var importe = parseFloat($(this).find('td:eq(6)').text());
                
                detalles.push({
                    codigo: codigo,
                    descripcion: descripcion,
                    unidad: unidad,
                    cantidad: cantidad,
                    precio: precio,
                    importe: importe
                });
            });
            calcularTotales();
        };

        function limpiarCampos() {
            $('#idproducto').val('').selectpicker('refresh');
            $('#unidad').val('');
            $('#precio').val('');
            $('#cantidad').val('');
            $('#stock').val('');
        }

        function calcularTotales() {
            var total = 0;
            for (var i = 0; i < detalles.length; i++) {
                total += detalles[i].importe;
            }

            $('#total').val(total.toFixed(2));

            // Verificar si el tipo es FACTURA para calcular y mostrar el IGV
            var tipoTexto = $('#idtipo option:selected').text().toUpperCase();
            if (tipoTexto.includes("FACTURA")) {
                let igv = total - (total / 1.18);
                $('#igv').val(igv.toFixed(2));
                $('#fila_igv').show();
            } else {
                $('#igv').val('');
                $('#fila_igv').hide();
            }
        }


        // Antes de enviar el formulario, agregar los detalles
        $('form').submit(function() {
            if (detalles.length === 0) {
                alert('Debe agregar al menos un producto');
                return false;
            }
            $('#detalles_json').val(JSON.stringify(detalles));
            return true;
        });
    });
</script>
{% endblock %}